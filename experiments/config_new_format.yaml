# =============================================================================
# EXAMPLE: Clean Configuration with Explicit Roles
# =============================================================================
# This format cleanly separates network configuration from application logic.
# The 'containernet' section handles all network/container setup.
# The 'application' section defines what commands run in which containers.
# =============================================================================

# -----------------------------------------------------------------------------
# CONTAINERNET CONFIGURATION
# Everything related to network topology, containers, and resources
# -----------------------------------------------------------------------------
containernet:
  # Number of containers (including server)
  num_containers: 3  # 1 server + 24 clients
  
  # Default Docker image for all containers
  image_name: anboiano/fedopt:latest
  
  # Device simulation (maps container index to device profile)
  # Container 0 is typically the server
  # Use 'none' or null for no constraints (full host resources)
  device_type:
    - none                # Container 0 (server) - no constraints
    - intel_nuc8                # Container 1
    - intel_nuc8                # Container 2
   
  # Network profiles (maps container index to network conditions)
  # Use 'none' or null for no limitations (unlimited bandwidth, zero delay)
  network_type:
    - none                # Container 0 (server) - no limitations
    - wifi_80211ac        # Container 1
    - 4g_lte_advanced     # Container 2
    
  
  # Resource management
  host_single_core_score: 1554
  device_variance: 0.05
  
  # Defaults (can be omitted - these are the default values)
  # cpu_spread_threshold: 0.8
  # allow_overscaling: true
  # enable_tcpdump: false
  enable_tcpdump: true
  
  # Per-container overrides (optional)
  # nodes:
  #   - id: 5
  #     image: custom/image:latest
  #     constraints:
  #       memory_mb: 4096
  #       cpu_quota: 50000
  #     link:
  #       delay_ms: 100
  #       bandwidth_mbps: 10

# -----------------------------------------------------------------------------
# APPLICATION CONFIGURATION
# Defines what runs in the containers - completely independent of network setup
# -----------------------------------------------------------------------------
application:
  name: mqtt_iid_FedAvg
  
  # Global variables available in all command templates
  # Use {variable_name} syntax in commands
  variables:
    protocol: mqtt
    port: 1883
    fl_method: FedAvgN
    alpha: 10
    rounds: 2
    epochs: 5
    min_clients: 2
    num_client: 2
    client_selection: false
    parts_dataset: 2
  
  # Define roles and their commands
  # Order matters - roles execute in the order listed in 'role_order'
  roles:
    server:
      # Which containers have this role (by index)
      container_ids: [0]
      
      # Command template - use {var} for variable substitution
      # Available variables:
      #   - All from 'variables' section above
      #   - container_id, container_name, container_ip, container_subnet
      #   - device_profile, network_profile
      #   - server_ip (for client roles)
      #   - output_dir, timestamp
      command: >-
        python3 -u run.py 
        --protocol {protocol} 
        --mode Server 
        --port {port} 
        --ip {container_ip} 
        --index {container_id}
        --rounds {rounds}
        --fl_method {fl_method}
        --alpha {alpha}
        --min_clients {min_clients}
        --num_client {num_client}
      
      # Delay before starting this role (seconds)
      startup_delay: 0
      
      # Wait for this role to complete before exiting
      wait_for_completion: true
      
      # Commands to run before the main command
      pre_commands:
        - "echo 'Starting server on {container_ip}'"
        - "mosquitto -c /etc/mosquitto/mosquitto.conf -v > /app/saved_output/mosquitto.log 2>&1 &"
        - "sleep 3"
    
    client:
      # Special value: "all_except_server" expands to all containers not in server role
      container_ids: "all_except_server"
      
      # IP Reference options:
      #   {ip_0} or {c0_ip} - Container 0's IP by index
      #   {server_ip} - First container in 'server' role
      command: >-
        python3 -u run.py 
        --protocol {protocol} 
        --mode Client 
        --my_ip {container_ip} 
        --port {port} 
        --ip {ip_0}
        --index {container_id}
        --epochs {epochs}
        --fl_method {fl_method}
        --alpha {alpha}
      
      # Wait for server to start before launching clients
      startup_delay: 10
      
      wait_for_completion: true
      
      pre_commands:
        - "echo 'Starting client {container_id} connecting to {ip_0}'"
  
  # Order in which roles are started
  role_order:
    - server
    - client

# -----------------------------------------------------------------------------
# NOTES
# -----------------------------------------------------------------------------
# For MQTT or other brokers, you have two options:
#
# 1. Run broker on server via pre_commands:
#    server:
#      pre_commands:
#        - "mosquitto -c /etc/mosquitto/mosquitto.conf &"
#        - "sleep 3"
#      command: "python3 run.py --mode Server ..."
#
# 2. Run broker as separate container with its own image:
#    broker:
#      container_ids: [0]
#      image: eclipse-mosquitto:latest  # Override Docker image for this role
#      command: "mosquitto -v"
#    server:
#      container_ids: [1]
#      command: "python3 run.py --mode Server --broker {broker_ip} ..."
#
# See examples/config_mqtt_patterns.yaml for complete examples.
